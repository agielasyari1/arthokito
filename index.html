<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BudgetKu - Smart Financial Management</title>
    <meta name="description" content="Kelola keuangan Anda dengan mudah dan aman menggunakan BudgetKu" />

    <!-- CSS -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>B</text></svg>"
    />

    <!-- Additional CSS for button fixes -->
    <style>
      /* Ensure action buttons are always clickable */
      .action-btn-small {
        cursor: pointer !important;
        pointer-events: auto !important;
        position: relative !important;
        z-index: 100 !important;
        border: none !important;
        border-radius: 4px !important;
        padding: 6px 8px !important;
        margin: 0 2px !important;
        font-size: 12px !important;
        line-height: 1 !important;
        display: inline-block !important;
        text-align: center !important;
        vertical-align: middle !important;
        transition: all 0.2s ease !important;
        min-width: 28px !important;
        min-height: 28px !important;
      }

      .action-btn-small.edit {
        background: #f59e0b !important;
        color: white !important;
      }

      .action-btn-small.edit:hover {
        background: #d97706 !important;
        transform: scale(1.05) !important;
      }

      .action-btn-small.delete {
        background: #ef4444 !important;
        color: white !important;
      }

      .action-btn-small.delete:hover {
        background: #dc2626 !important;
        transform: scale(1.05) !important;
      }

      /* Ensure transaction actions container doesn't interfere */
      .transaction-actions {
        display: flex !important;
        gap: 4px !important;
        align-items: center !important;
        position: relative !important;
        z-index: 50 !important;
      }

      .account-actions {
        display: flex !important;
        gap: 4px !important;
        align-items: center !important;
        position: relative !important;
        z-index: 50 !important;
      }

      .goal-actions {
        display: flex !important;
        gap: 4px !important;
        align-items: center !important;
        position: relative !important;
        z-index: 50 !important;
      }

      /* Prevent parent containers from blocking clicks */
      .transaction-item,
      .account-card,
      .goal-card {
        position: relative !important;
      }

      .transaction-item *,
      .account-card *,
      .goal-card * {
        pointer-events: auto !important;
      }

      /* Debug styling to make buttons more visible */
      .action-btn-small {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .action-btn-small {
          min-width: 32px !important;
          min-height: 32px !important;
          padding: 8px !important;
          font-size: 14px !important;
        }
      }

      /* ===== MODAL FIX ===== */

      /* Force modal container to be properly positioned and visible when active */
      .modal-container {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 99999 !important;
        display: none !important; /* Hide by default */
        align-items: center !important;
        justify-content: center !important;
        padding: 20px !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
      }

      /* Show modal container when active */
      .modal-container.active,
      .modal-container[style*="flex"] {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Modal content positioning */
      .modal-content {
        position: relative !important;
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        max-width: 500px !important;
        width: 90% !important;
        max-height: 80vh !important;
        overflow: hidden !important;
        z-index: 100000 !important;
      }

      /* Modal overlay click handling */
      .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 99999 !important;
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        background: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px) !important;
      }

      .modal-overlay.active {
        display: flex !important;
      }

      .modal-backdrop {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: transparent !important;
        cursor: pointer !important;
      }

      /* Ensure modal form is scrollable */
      .modal-form {
        max-height: 60vh !important;
        overflow-y: auto !important;
        padding: 20px !important;
      }

      /* Make sure modal buttons are always clickable */
      .modal-close {
        background: #f3f4f6 !important;
        border: none !important;
        border-radius: 50% !important;
        width: 32px !important;
        height: 32px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        color: #6b7280 !important;
        font-size: 18px !important;
        font-weight: bold !important;
        z-index: 100001 !important;
        position: relative !important;
      }

      .modal-close:hover {
        background: #e5e7eb !important;
        color: #374151 !important;
      }

      /* Debug: add visible border to modal container when active */
      /*.modal-container.active {
            border: 2px solid red !important;
        }*/

      /* Make form inputs more visible */
      .form-input,
      .form-select {
        border: 2px solid #d1d5db !important;
        border-radius: 8px !important;
        padding: 10px !important;
        font-size: 14px !important;
        background: white !important;
        color: #1f2937 !important; /* Force dark text */
      }

      .form-input:focus,
      .form-select:focus {
        border-color: #3b82f6 !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
      }

      /* Modal text styling - force visibility */
      .modal {
        color: #1f2937 !important; /* Force dark text for light modal background */
      }

      .modal-title {
        color: #111827 !important; /* Darker title */
        font-weight: 700 !important;
      }

      .form-label {
        color: #374151 !important; /* Dark gray for labels */
        font-weight: 600 !important;
      }

      .form-help {
        color: #6b7280 !important; /* Medium gray for help text */
      }

      /* Dark theme modal adjustments */
      .dark-theme .modal {
        background: #1f2937 !important; /* Dark background in dark mode */
        color: #f9fafb !important; /* Light text in dark mode */
        border: 1px solid #374151 !important;
      }

      .dark-theme .modal-title {
        color: #f9fafb !important;
      }

      .dark-theme .form-label {
        color: #e5e7eb !important;
      }

      .dark-theme .form-input,
      .dark-theme .form-select {
        background: #374151 !important;
        color: #f9fafb !important;
        border-color: #4b5563 !important;
      }

      .dark-theme .form-input:focus,
      .dark-theme .form-select:focus {
        border-color: #60a5fa !important;
        background: #374151 !important;
      }

      .dark-theme .form-help {
        color: #9ca3af !important;
      }

      .dark-theme .modal-backdrop {
        background: rgba(0, 0, 0, 0.7) !important;
      }

      /* Theme toggle button styling */
      .theme-toggle {
        background: none !important;
        border: none !important;
        font-size: 20px !important;
        cursor: pointer !important;
        padding: 8px !important;
        border-radius: 8px !important;
        transition: all 0.2s ease !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 40px !important;
        height: 40px !important;
      }

      .theme-toggle:hover {
        background: rgba(0, 0, 0, 0.1) !important;
      }

      .dark-theme .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1) !important;
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div class="loading-overlay active" id="loading-overlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Memuat BudgetKu...</div>
      </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
      <!-- Initial content will be replaced by AuthUI or main app -->
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          flex-direction: column;
          gap: 20px;
        "
      >
        <div style="font-size: 4rem">B</div>
        <h1 style="margin: 0; color: #374151">BudgetKu</h1>
        <p style="margin: 0; color: #6b7280">Memuat aplikasi...</p>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Modal Container -->
    <div id="modalContainer" class="modal-container"></div>

    <!-- Scripts -->

    <!-- Core Dependencies -->
    <script src="js/SupabaseConfig.js"></script>

    <!-- Core Budget Manager -->
    <script src="js/BudgetManager.js"></script>
    <script src="js/SupabaseBudgetManager.js"></script>

    <!-- Analytics Engine -->
    <script src="js/Analytics.js"></script>

    <!-- UI Components -->
    <script src="js/UIComponents.js"></script>

    <!-- Main UI Controller -->
    <script src="js/UI.js"></script>

    <!-- Auth UI -->
    <script src="js/AuthUI.js"></script>

    <!-- App Initialization -->
    <script>
      // Global app initialization
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("BudgetKu App Starting...");

        try {
          // Show loading
          const loadingOverlay = document.getElementById("loading-overlay");

          // Initialize Supabase Budget Manager first
          console.log("Initializing Supabase integration...");
          if (window.supabaseBudgetManager) {
            await window.supabaseBudgetManager.initialize();
            // Use SupabaseBudgetManager as the main budget manager
            window.budgetManager = window.supabaseBudgetManager;
          } else {
            console.warn("Supabase integration not available, falling back to local storage");
            window.budgetManager = new BudgetManager();
          }

          // Initialize analytics and components with the budget manager
          window.analytics = new Analytics(window.budgetManager);
          window.components = new UIComponents(window.budgetManager, window.analytics);

          // Initialize Auth UI (this will handle showing the auth screen or main app)
          console.log("Initializing Auth UI...");
          if (window.authUI) {
            await window.authUI.initialize();
          }

          // Create a simple UI class for compatibility
          class SimpleUI {
            constructor() {
              this.budgetManager = null;
              this.modernUI = null;
              this.analytics = null;
              this.currentView = "dashboard";
              this.isInitialized = false;
              this.initialize();
            }

            async initialize() {
              try {
                // Initialize SupabaseBudgetManager if available
                if (window.supabaseBudgetManager) {
                  this.budgetManager = window.supabaseBudgetManager;
                  await this.budgetManager.initialize();
                } else {
                  // Fallback to local BudgetManager
                  this.budgetManager = new BudgetManager();
                  await this.budgetManager.loadData();
                }

                // Initialize ModernBudgetUI
                this.modernUI = new ModernBudgetUI(this.budgetManager);
                await this.modernUI.init();

                // Initialize Analytics
                this.analytics = new Analytics(this.budgetManager);
                await this.analytics.initialize();

                // Bind all menu events
                this.bindMenuEvents();

                // Initialize page-specific features
                this.initializePageSpecific();

                // Show initial view
                this.smoothSwitchView("dashboard");

                this.isInitialized = true;
                console.log("✅ SimpleUI initialized successfully");
              } catch (error) {
                console.error("❌ Failed to initialize SimpleUI:", error);
                this.showError("Failed to initialize application");
              }
            }

            bindMenuEvents() {
              // Main navigation
              document.querySelectorAll("[data-page]").forEach((element) => {
                element.addEventListener("click", (e) => {
                  e.preventDefault();
                  const page = element.getAttribute("data-page");
                  if (page) {
                    this.smoothSwitchView(page);
                  }
                });
              });

              // Analytics tabs
              document.querySelectorAll(".analytics-tab").forEach((tab) => {
                tab.addEventListener("click", (e) => {
                  e.preventDefault();
                  const tabName = tab.getAttribute("data-tab");
                  if (tabName && this.modernUI) {
                    this.modernUI.switchAnalyticsTab(tabName);
                  }
                });
              });

              // Quick add buttons
              document.querySelectorAll(".quick-add-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.preventDefault();
                  const type = btn.getAttribute("data-type");
                  if (type && this.modernUI) {
                    this.modernUI.showQuickAddModal(type);
                  }
                });
              });

              // Account actions
              document.querySelectorAll(".account-action").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.preventDefault();
                  const action = btn.getAttribute("data-action");
                  const accountId = btn.getAttribute("data-account-id");
                  if (action && accountId && this.modernUI) {
                    this.modernUI.handleAccountAction(action, accountId);
                  }
                });
              });

              // Goal actions
              document.querySelectorAll(".goal-action").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.preventDefault();
                  const action = btn.getAttribute("data-action");
                  const goalId = btn.getAttribute("data-goal-id");
                  if (action && goalId && this.modernUI) {
                    this.modernUI.handleGoalAction(action, goalId);
                  }
                });
              });

              // Transaction actions
              document.querySelectorAll(".transaction-action").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.preventDefault();
                  const action = btn.getAttribute("data-action");
                  const transactionId = btn.getAttribute("data-transaction-id");
                  if (action && transactionId && this.modernUI) {
                    this.modernUI.handleTransactionAction(action, transactionId);
                  }
                });
              });

              // Theme toggle
              const themeToggle = document.getElementById("themeToggle");
              if (themeToggle) {
                themeToggle.addEventListener("click", () => {
                  this.modernUI.toggleTheme();
                });
              }

              // Mobile menu toggle
              const menuToggle = document.getElementById("menuToggle");
              if (menuToggle) {
                menuToggle.addEventListener("click", () => {
                  this.modernUI.toggleMobileSidebar();
                });
              }

              // Export/Import actions
              document.querySelectorAll(".data-action").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.preventDefault();
                  const action = btn.getAttribute("data-action");
                  if (action && this.modernUI) {
                    switch (action) {
                      case "export":
                        this.modernUI.exportBudgetReport();
                        break;
                      case "import":
                        this.modernUI.showImportModal();
                        break;
                      case "reset":
                        this.modernUI.showResetConfirmation();
                        break;
                    }
                  }
                });
              });
            }

            initializePageSpecific() {
              // Initialize charts and analytics
              if (this.analytics) {
                this.analytics.initializeCharts();
              }

              // Initialize animations
              this.initializeAnimations();

              // Initialize keyboard shortcuts
              this.initializeKeyboardShortcuts();

              // Initialize swipe gestures
              this.initializeSwipeGestures();
            }

            initializeAnimations() {
              // Add animations to stat cards
              document.querySelectorAll(".stat-card").forEach((card) => {
                card.classList.add("animate-in");
              });

              // Add animations to list items
              document.querySelectorAll(".list-item").forEach((item, index) => {
                item.style.animationDelay = `${index * 0.1}s`;
                item.classList.add("animate-in");
              });
            }

            initializeKeyboardShortcuts() {
              document.addEventListener("keydown", (e) => {
                // Alt + N for new transaction
                if (e.altKey && e.key === "n") {
                  e.preventDefault();
                  this.modernUI.showQuickAddModal("expense");
                }
                // Alt + A for new account
                if (e.altKey && e.key === "a") {
                  e.preventDefault();
                  this.modernUI.showAddAccountModal();
                }
                // Alt + G for new goal
                if (e.altKey && e.key === "g") {
                  e.preventDefault();
                  this.modernUI.showAddGoalModal();
                }
                // Alt + B for budget settings
                if (e.altKey && e.key === "b") {
                  e.preventDefault();
                  this.modernUI.showSetBudgetModal();
                }
              });
            }

            initializeSwipeGestures() {
              let touchStartX = 0;
              let touchEndX = 0;

              document.addEventListener("touchstart", (e) => {
                touchStartX = e.changedTouches[0].screenX;
              });

              document.addEventListener("touchend", (e) => {
                touchEndX = e.changedTouches[0].screenX;
                this.handleSwipe(touchStartX, touchEndX);
              });
            }

            handleSwipe(startX, endX) {
              const swipeThreshold = 50;
              const diff = startX - endX;

              if (Math.abs(diff) < swipeThreshold) return;

              const views = ["dashboard", "transactions", "accounts", "goals", "analytics"];
              const currentIndex = views.indexOf(this.currentView);

              if (diff > 0 && currentIndex < views.length - 1) {
                // Swipe left - next view
                this.smoothSwitchView(views[currentIndex + 1]);
              } else if (diff < 0 && currentIndex > 0) {
                // Swipe right - previous view
                this.smoothSwitchView(views[currentIndex - 1]);
              }
            }

            async smoothSwitchView(view) {
              if (!this.isInitialized || view === this.currentView) return;

              try {
                // Show loading state
                this.modernUI.showLoadingOverlay();

                // Update current view
                this.currentView = view;

                // Update navigation states
                this.updateNavigationStates(view);

                // Update page header
                this.updatePageHeader(view);

                // Render the new view
                await this.modernUI.render();

                // Initialize page-specific features
                this.initializePageSpecific();

                // Hide loading state
                this.modernUI.hideLoadingOverlay();

                // Close mobile sidebar if open
                this.modernUI.closeMobileSidebar();

                console.log(`✅ Switched to ${view} view`);
              } catch (error) {
                console.error(`❌ Failed to switch to ${view} view:`, error);
                this.showError("Failed to switch view");
              }
            }

            updateNavigationStates(view) {
              // Update main navigation
              document.querySelectorAll("[data-page]").forEach((element) => {
                const page = element.getAttribute("data-page");
                if (page === view) {
                  element.classList.add("active");
                } else {
                  element.classList.remove("active");
                }
              });

              // Update bottom navigation
              document.querySelectorAll(".bottom-nav-item").forEach((element) => {
                const page = element.getAttribute("data-page");
                if (page === view) {
                  element.classList.add("active");
                } else {
                  element.classList.remove("active");
                }
              });
            }

            updatePageHeader(view) {
              const header = document.querySelector(".page-header h1");
              if (header) {
                switch (view) {
                  case "dashboard":
                    header.textContent = "Dashboard";
                    break;
                  case "transactions":
                    header.textContent = "Transactions";
                    break;
                  case "accounts":
                    header.textContent = "Accounts";
                    break;
                  case "goals":
                    header.textContent = "Goals";
                    break;
                  case "analytics":
                    header.textContent = "Analytics";
                    break;
                }
              }
            }

            showError(message) {
              if (this.modernUI) {
                this.modernUI.showToast(message, "error");
              }
            }

            setBudgetManager(manager) {
              this.budgetManager = manager;
              if (this.modernUI) {
                this.modernUI.setBudgetManager(manager);
              }
              if (this.analytics) {
                this.analytics.setBudgetManager(manager);
              }
            }
          }

          // Initialize SimpleUI
          window.ui = new SimpleUI();
          await window.ui.initialize();

          // Add global functions
          window.showQuickAddModal = function (type) {
            try {
              console.log("Showing quick add modal for:", type);
              const component = window.ui?.components || window.modernUI?.components;
              if (component && component.showQuickAddModal) {
                component.showQuickAddModal(type);
              } else {
                throw new Error("UI Components not available");
              }
            } catch (error) {
              console.error("Error in showQuickAddModal:", error);
              alert(
                "Tidak dapat membuka modal " +
                  (type === "income" ? "pemasukan" : "pengeluaran") +
                  ".\n\nError: " +
                  error.message +
                  "\n\nSilakan refresh halaman dan coba lagi."
              );
            }
          };

          window.hideModal = function () {
            try {
              const modalContainer = document.getElementById("modalContainer");
              if (modalContainer) {
                modalContainer.style.display = "none";
                modalContainer.classList.remove("active");
              }
            } catch (error) {
              console.error("Error hiding modal:", error);
            }
          };

          window.showAddAccountModal = function () {
            try {
              const component = window.ui?.components || window.modernUI?.components;
              if (component && component.showAddAccountModal) {
                component.showAddAccountModal();
              } else {
                throw new Error("UI Components not available");
              }
            } catch (error) {
              console.error("Error in showAddAccountModal:", error);
              alert(
                "Tidak dapat membuka modal tambah akun.\n\nError: " +
                  error.message +
                  "\n\nSilakan refresh halaman dan coba lagi."
              );
            }
          };

          window.showAddGoalModal = function () {
            try {
              const component = window.ui?.components || window.modernUI?.components;
              if (component && component.showAddGoalModal) {
                component.showAddGoalModal();
              } else {
                throw new Error("UI Components not available");
              }
            } catch (error) {
              console.error("Error in showAddGoalModal:", error);
              alert(
                "Tidak dapat membuka modal tambah target.\n\nError: " +
                  error.message +
                  "\n\nSilakan refresh halaman dan coba lagi."
              );
            }
          };

          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.classList.remove("active");
          }

          console.log("BudgetKu App Started Successfully");
        } catch (error) {
          console.error("Failed to start BudgetKu:", error);
          alert("Gagal memulai aplikasi: " + error.message);
        }
      });
    </script>

    <!-- Analytics (optional) -->
    <script>
      // Google Analytics atau analytics lainnya bisa ditambahkan di sini
      // gtag('config', 'GA_MEASUREMENT_ID');
    </script>
  </body>
</html>
